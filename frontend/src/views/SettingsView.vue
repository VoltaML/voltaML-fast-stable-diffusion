<template>
  <div class="main-container">
    <NCard>
      <NTabs>
        <NTabPane name="Frontend">
          <FrontendSettings />
        </NTabPane>
        <NTabPane name="API">
          <APISettings />
        </NTabPane>
        <NTabPane name="Bot">
          <BotSettings />
        </NTabPane>
        <NTabPane name="General">
          <GeneralSettings />
        </NTabPane>
        <NTabPane name="Extra">
          <ExtraSettings />
        </NTabPane>

        <template #suffix>
          <NButton
            type="error"
            ghost
            style="margin-right: 12px"
            @click="resetSettings"
            >Reset Settings</NButton
          >
          <NButton type="success" ghost @click="saveSettings" :loading="saving"
            >Save Settings</NButton
          >
        </template>
      </NTabs>
    </NCard>
  </div>
</template>

<script lang="ts" setup>
import APISettings from "@/components/settings/APISettings.vue";
import BotSettings from "@/components/settings/BotSettings.vue";
import ExtraSettings from "@/components/settings/ExtraSettings.vue";
import FrontendSettings from "@/components/settings/FrontendSettings.vue";
import GeneralSettings from "@/components/settings/GeneralSettings.vue";
import { serverUrl } from "@/env";
import { defaultSettings } from "@/settings";
import { useSettings } from "@/store/settings";
import {
  NButton,
  NCard,
  NTabPane,
  NTabs,
  useMessage,
  useNotification,
} from "naive-ui";
import { onUnmounted, ref } from "vue";

const message = useMessage();
const settings = useSettings();
const notification = useNotification();

const saving = ref(false);

function resetSettings() {
  // Deepcopy and assign
  Object.assign(
    settings.defaultSettings,
    JSON.parse(JSON.stringify(defaultSettings))
  );

  message.warning(
    "Settings were reset to default values, please save them if you want to keep them"
  );
}

function saveSettings() {
  saving.value = true;

  fetch(`${serverUrl}/api/settings/save`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(settings.defaultSettings),
  }).then((res) => {
    if (res.status === 200) {
      message.success("Settings saved successfully");
    } else {
      res.json().then((data) => {
        message.error("Error while saving settings");
        notification.create({
          title: "Error while saving settings",
          content: data.message,
          type: "error",
        });
      });
    }

    saving.value = false;
  });
}

onUnmounted(() => {
  saveSettings();
});
</script>
